<html>

<head>
  <meta charset="UTF-8" />
  <script src="https://unpkg.com/three@0.139.2/build/three.min.js"></script>
  <script
    src="https://unpkg.com/three@0.139.2/examples/js/controls/OrbitControls.js"></script>
  <script
    src="https://unpkg.com/three@0.139.2/examples/js/loaders/OBJLoader.js"></script>
  <script
    src="https://unpkg.com/three@0.139.2/examples/js/loaders/MTLLoader.js"></script>
  <script>

    const scaleToFit = (model) => {
      const box3 = new THREE.Box3().setFromObject(model);
      const size = new THREE.Vector3();
      box3.getSize(size);

      const scale = 0.5 / (box3.max.z - box3.min.z);
      model.scale.set(scale, scale, scale);
    }

    const model3dMtl = (scene, obj, materialImage, { position, scale, rotation }) => {
      const objLoader = new THREE.OBJLoader();
      const mtlLoader = new THREE.MTLLoader();

      mtlLoader.load(
        materialImage,
        (materials) => {
          materials.preload();
          objLoader.setMaterials(materials);
          objLoader.load(
            obj,
            (object) => {
              scaleToFit(object);
              if (position) object.position.set(position[0], position[1], position[2]);
              if (rotation) object.rotation.set(rotation[0], rotation[1], rotation[2]);
              scene.add(object);
            },
            (xhr) => {
              console.log((xhr.loaded / xhr.total) * 100 + "% loaded");
            },
            (error) => console.log(error)
          );
        },
        (xhr) => {
          console.log((xhr.loaded / xhr.total) * 100 + "% loaded");
        },
        (error) => console.log(error)
      );
    }

    const model3d = (scene, obj, materialImage, { position, scale, rotation }) => {
      const objLoader = new THREE.OBJLoader();
      const texLoader = new THREE.TextureLoader();

      if (materialImage && materialImage.split(".").reverse()[0] == "mtl") {
        return model3dMtl(scene, obj, materialImage, { position, scale, rotation });
      }

      const texture = !!materialImage ? texLoader.load(materialImage) : null;
      const material = new THREE.MeshPhongMaterial({
        map: texture,
      });

      objLoader.load(obj, (model) => {
        model.traverse(function (child) {
          if (child instanceof THREE.Mesh) {
            child.material = material;
          }
        });
        scaleToFit(model);
        if (position) model.position.set(position[0], position[1], position[2]);
        if (rotation) model.rotation.set(rotation[0], rotation[1], rotation[2]);
        scene.add(model);
      });
    }

    // ページの読み込みを待つ
    window.addEventListener(`DOMContentLoaded`, () => {
      const myCanvas = document.querySelector('#myCanvas');

      // シーンを初期化
      const scene = new THREE.Scene();

      const ambientLight = new THREE.AmbientLight(0xc0c0c0);
      scene.add(ambientLight)

      const directLight = new THREE.DirectionalLight(0xf0f0f0, 0.2)
      scene.add(directLight)

      // カメラを初期化
      const camera = new THREE.PerspectiveCamera(
        50,
        myCanvas.offsetWidth / myCanvas.offsetHeight
      );
      camera.position.set(1, 1, 1);
      camera.lookAt(scene.position);

      // レンダラーの初期化
      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        canvas: myCanvas,
      });
      renderer.setClearColor(0xffffff, 1.0); // 背景色
      // renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(myCanvas.offsetWidth, myCanvas.offsetHeight);

      // カメラコントローラー設定
      const orbitControls = new THREE.OrbitControls(
        camera,
        renderer.domElement
      );
      orbitControls.maxPolarAngle = Math.PI * 0.5;
      orbitControls.minDistance = 0.1;
      orbitControls.maxDistance = 100;
      orbitControls.autoRotate = true; // カメラの自動回転設定
      orbitControls.autoRotateSpeed = 1.0; // カメラの自動回転速度

      model3d(scene, "BreadObj/Bread.obj", "BreadObj/Bread.mtl", {
        scale: 10,
        position: [0, 0, 0],
      });

      // 描画ループを開始
      renderer.setAnimationLoop(() => {
        // カメラコントローラーを更新
        orbitControls.update();

        // 描画する
        renderer.render(scene, camera);
      });
    });
  </script>
</head>

<body>
  <canvas id="myCanvas" style="width: 100%; height: 100%"></canvas>
</body>

</html>